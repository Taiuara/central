<!DOCTYPE html>
<html>
<head>
    <title>Setup Central do Provedor</title>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, collection, getDocs, addDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyD8RqsjXByWhRYgRgGEJE19iXpk0J68tgc",
            authDomain: "central-provedor-35ef4.firebaseapp.com",
            projectId: "central-provedor-35ef4",
            storageBucket: "central-provedor-35ef4.firebasestorage.app",
            messagingSenderId: "242631943904",
            appId: "1:242631943904:web:e14e01cac0e1ec83401285"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        window.checkUsers = async function() {
            const log = document.getElementById('log');
            log.innerHTML = '';
            
            function addLog(message) {
                log.innerHTML += message + '<br>';
                console.log(message);
            }

            try {
                addLog('üîç Verificando usu√°rios no sistema...');
                
                // Login como admin
                try {
                    await signInWithEmailAndPassword(auth, 'admin@pingdesk.com.br', 'admin123');
                    addLog('‚úÖ Login admin realizado');
                } catch (error) {
                    addLog('‚ùå Erro no login admin: ' + error.message);
                    return;
                }

                // Verificar usu√°rios
                const usersSnap = await getDocs(collection(db, 'users'));
                addLog('üë• Total de usu√°rios no Firestore: ' + usersSnap.size);
                
                if (usersSnap.size === 0) {
                    addLog('‚ö†Ô∏è Nenhum usu√°rio encontrado, criando admin...');
                    
                    await setDoc(doc(db, 'users', auth.currentUser.uid), {
                        name: 'Administrador',
                        email: 'admin@pingdesk.com.br',
                        role: 'admin',
                        createdAt: new Date(),
                        updatedAt: new Date()
                    });
                    
                    addLog('‚úÖ Usu√°rio admin criado no Firestore');
                } else {
                    usersSnap.forEach(doc => {
                        const user = doc.data();
                        addLog(`üë§ ${user.name} (${user.email}) - ${user.role} - ID: ${doc.id}`);
                    });
                }

                addLog('üéâ Verifica√ß√£o conclu√≠da! Recarregue a p√°gina de usu√°rios.');

            } catch (error) {
                addLog('‚ùå Erro: ' + error.message);
                console.error(error);
            }
        };

        window.debugData = async function() {
            const log = document.getElementById('log');
            log.innerHTML = '';
            
            function addLog(message) {
                log.innerHTML += message + '<br>';
                console.log(message);
            }

            try {
                addLog('üîç Verificando dados existentes...');
                
                // Login como admin para ter permiss√µes
                try {
                    await signInWithEmailAndPassword(auth, 'admin@pingdesk.com.br', 'admin123');
                    addLog('‚úÖ Login admin realizado');
                } catch (error) {
                    addLog('‚ùå Erro no login admin: ' + error.message);
                    return;
                }

                // Verificar provedores
                const providersSnap = await getDocs(collection(db, 'providers'));
                addLog('üìã Provedores encontrados: ' + providersSnap.size);
                providersSnap.forEach(doc => {
                    addLog('  ‚úÖ ' + doc.data().name + ' (ID: ' + doc.id + ')');
                });

                // Verificar usu√°rios
                const usersSnap = await getDocs(collection(db, 'users'));
                addLog('üë• Usu√°rios encontrados: ' + usersSnap.size);
                usersSnap.forEach(doc => {
                    const user = doc.data();
                    addLog('  ‚úÖ ' + user.email + ' (' + user.role + ') - ProviderId: ' + (user.providerId || 'N/A'));
                });

                // Verificar tickets
                const ticketsSnap = await getDocs(collection(db, 'tickets'));
                addLog('üé´ Tickets encontrados: ' + ticketsSnap.size);
                ticketsSnap.forEach(doc => {
                    const ticket = doc.data();
                    addLog('  ‚úÖ ' + ticket.clientName + ' - Provider: ' + ticket.providerId + ' (' + ticket.level + ')');
                });

            } catch (error) {
                addLog('‚ùå Erro: ' + error.message);
                console.error(error);
            }
        };

        window.setupData = async function() {
            const log = document.getElementById('log');
            log.innerHTML = '';
            
            function addLog(message) {
                log.innerHTML += message + '<br>';
                console.log(message);
            }

            try {
                addLog('üöÄ Iniciando setup...');
                
                // 1. Criar usu√°rio admin
                addLog('üîê Criando usu√°rio admin...');
                try {
                    const adminCredential = await createUserWithEmailAndPassword(auth, 'admin@pingdesk.com.br', 'admin123');
                    addLog('‚úÖ Usu√°rio admin criado: ' + adminCredential.user.uid);
                    
                    await setDoc(doc(db, 'users', adminCredential.user.uid), {
                        name: 'Administrador',
                        email: 'admin@pingdesk.com.br',
                        role: 'admin',
                        createdAt: new Date(),
                        updatedAt: new Date()
                    });
                    addLog('‚úÖ Documento admin criado no Firestore');
                    
                } catch (error) {
                    if (error.code === 'auth/email-already-in-use') {
                        addLog('‚ö†Ô∏è Admin j√° existe, fazendo login...');
                        await signInWithEmailAndPassword(auth, 'admin@pingdesk.com.br', 'admin123');
                        addLog('‚úÖ Login admin realizado');
                    } else {
                        addLog('‚ùå Erro admin: ' + error.message);
                        return;
                    }
                }

                // 2. Criar provedor
                addLog('üè¢ Criando provedor...');
                const providerRef = await addDoc(collection(db, 'providers'), {
                    name: 'Provedor Teste',
                    fixedValue: 1000,
                    valueN1: 15,
                    valueN2: 25,
                    valueMassive: 100,
                    periodType: 'fixed',
                    startDay: 15,
                    createdAt: new Date(),
                    updatedAt: new Date()
                });
                addLog('‚úÖ Provedor criado: ' + providerRef.id);

                // 3. Criar usu√°rio provider
                addLog('üë§ Criando usu√°rio provider...');
                try {
                    const providerCredential = await createUserWithEmailAndPassword(auth, 'provider@teste.com', 'provider123');
                    addLog('‚úÖ Usu√°rio provider criado: ' + providerCredential.user.uid);
                    
                    await setDoc(doc(db, 'users', providerCredential.user.uid), {
                        name: 'Usu√°rio Provider Teste',
                        email: 'provider@teste.com',
                        role: 'provider',
                        providerId: providerRef.id,
                        createdAt: new Date(),
                        updatedAt: new Date()
                    });
                    addLog('‚úÖ Documento provider criado no Firestore');
                    
                } catch (error) {
                    if (error.code === 'auth/email-already-in-use') {
                        addLog('‚ö†Ô∏è Provider j√° existe');
                    } else {
                        addLog('‚ùå Erro provider: ' + error.message);
                    }
                }

                // 4. Criar ticket de teste
                addLog('üé´ Criando ticket de teste...');
                await addDoc(collection(db, 'tickets'), {
                    providerId: providerRef.id,
                    providerName: 'Provedor Teste',
                    clientName: 'Cliente Teste',
                    whatsapp: '11999999999',
                    protocol: 'TESTE001',
                    attendanceDate: new Date(),
                    level: 'N1',
                    description: 'Ticket de teste para validar sistema',
                    createdBy: auth.currentUser.uid,
                    createdAt: new Date(),
                    updatedAt: new Date()
                });
                addLog('‚úÖ Ticket criado');

                addLog('üéâ Setup conclu√≠do com sucesso!');
                addLog('');
                addLog('üìß Credenciais criadas:');
                addLog('Admin: admin@pingdesk.com.br / admin123');
                addLog('Provider: provider@teste.com / provider123');
                addLog('');
                addLog('üåê Agora voc√™ pode acessar: http://localhost:3000');

            } catch (error) {
                addLog('‚ùå Erro: ' + error.message);
                console.error(error);
            }
        };
    </script>
    <style>
        body { font-family: monospace; padding: 20px; }
        button { padding: 10px 20px; font-size: 16px; margin-bottom: 20px; }
        #log { background: #f0f0f0; padding: 15px; border-radius: 5px; min-height: 200px; }
    </style>
</head>
<body>
    <h1>Setup Central do Provedor</h1>
    <p>Este script ir√° criar os dados iniciais necess√°rios para testar o sistema.</p>
    
    <button onclick="setupData()">üöÄ Executar Setup</button>
    <button onclick="debugData()">üîç Debug Dados</button>
    <button onclick="checkUsers()">üë• Verificar Usu√°rios</button>
    
    <div id="log"></div>
</body>
</html>
